#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ Telegram –±–æ—Ç–∞ (–æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä)

BOT_DIR="/Users/sergey/Work/AI PROJECTS/CHATBOT"
BOT_SCRIPT="bot.py"
LOG_FILE="$BOT_DIR/bot.log"
PID_FILE="$BOT_DIR/.bot_pid"
LOCK_FILE="/tmp/telegram_bot.lock"

echo "================================================"
echo "–ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞..."
echo "================================================"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ –±–æ—Ç–∞
if [ ! -f "$BOT_DIR/$BOT_SCRIPT" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª $BOT_SCRIPT –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $BOT_DIR"
    exit 1
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
RUNNING_PIDS=$(pgrep -f "$BOT_DIR/$BOT_SCRIPT" || true)

if [ -n "$RUNNING_PIDS" ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞: $RUNNING_PIDS"
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    
    for PID in $RUNNING_PIDS; do
        kill -9 $PID 2>/dev/null && echo "   ‚úì –ü—Ä–æ—Ü–µ—Å—Å $PID –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    done
    
    sleep 2
else
    echo "‚úì –ó–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
STILL_RUNNING=$(pgrep -f "$BOT_DIR/$BOT_SCRIPT" | wc -l | tr -d ' ')
if [ "$STILL_RUNNING" -gt 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã"
    exit 1
fi

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞
cd "$BOT_DIR" || exit 1

# –û—á–∏—Å—Ç–∫–∞ stale lock –∏ PID-—Ñ–∞–π–ª–∞
rm -f "$LOCK_FILE" "$PID_FILE"

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –ª–æ–≥-—Ñ–∞–π–ª–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if [ -f "$LOG_FILE" ]; then
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫ —Å—Ç–∞—Ä–æ–≥–æ –ª–æ–≥–∞
    tail -100 "$LOG_FILE" > "$LOG_FILE.tmp" 2>/dev/null
    mv "$LOG_FILE.tmp" "$LOG_FILE" 2>/dev/null
fi

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
echo "üöÄ –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞..."
nohup env MPLCONFIGDIR="$BOT_DIR/.mplconfig" PYTHONUNBUFFERED=1 "$BOT_DIR/.venv/bin/python" "$BOT_DIR/$BOT_SCRIPT" >> "$LOG_FILE" 2>&1 < /dev/null &
NEW_PID=$!

# –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å–∫–∞
sleep 2

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ps -p $NEW_PID > /dev/null 2>&1; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω (PID: $NEW_PID)"
    echo "üìù –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤: $LOG_FILE"
    echo "================================================"
    echo ""
    echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
    echo "  tail -f $LOG_FILE"
    echo ""
    echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞:"
    echo "  kill $NEW_PID"
    echo "–∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç ./stop_bot.sh"
    echo "================================================"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º PID –≤ —Ñ–∞–π–ª –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    echo $NEW_PID > "$BOT_DIR/.bot_pid"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –±–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -20 $LOG_FILE"
    exit 1
fi
